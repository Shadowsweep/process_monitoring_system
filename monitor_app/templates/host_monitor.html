<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Host Monitor</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #fff;
        color: #000;
        padding: 20px;
    }

    h2 {
        border-bottom: 2px solid #000;
        padding-bottom: 5px;
    }

    #hosts-list button {
        background-color: #000;
        color: #fff;
        border: none;
        padding: 10px 15px;
        margin: 5px 0;
        cursor: pointer;
        border-radius: 5px;
        transition: all 0.2s ease;
    }

    #hosts-list button:hover {
        background-color: #555;
    }

    #hosts-list button.active {
        background-color: #007bff;
    }

    .toggle-btn {
        background-color: #000;
        color: #fff;
        border: none;
        padding: 8px 12px;
        margin: 10px 5px;
        cursor: pointer;
        border-radius: 5px;
        transition: all 0.2s ease;
    }

    .toggle-btn:hover {
        background-color: #555;
    }

    .hidden {
        display: none;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        margin-bottom: 20px;
    }

    table, th, td {
        border: 1px solid #000;
    }

    th, td {
        padding: 8px;
        text-align: left;
    }

    tr.subprocess-row {
        display: none;
        background-color: #f2f2f2;
    }

    tr:hover {
        background-color: #e0e0e0;
    }

    .expand-btn {
        cursor: pointer;
        font-weight: bold;
        margin-right: 5px;
    }

    .status {
        padding: 5px;
        border-radius: 3px;
        font-weight: bold;
        display: inline-block;
        min-width: 100px;
        text-align: center;
    }

    .status.connected {
        background-color: #d4edda;
        color: #155724;
    }

    .status.disconnected {
        background-color: #f8d7da;
        color: #721c24;
    }

    .status.connecting {
        background-color: #fff3cd;
        color: #856404;
    }

    .last-update {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
    }
</style>
</head>
<body>

<h2>Host Monitor</h2>

<div class="status" id="connection-status">Disconnected</div>
<div class="last-update" id="last-update"></div>

<ul id="hosts-list">
    <li><button onclick="selectHost('LAPTOP-7UTNLTAQ')">LAPTOP-7UTNLTAQ</button></li>
</ul>

<div id="host-controls" class="hidden">
    <button class="toggle-btn" onclick="toggleSection('system-section')">System Details</button>
    <button class="toggle-btn" onclick="toggleSection('process-section')">Process Details</button>
</div>

<div id="system-section" class="hidden">
    <h3>System Info</h3>
    <table>
        <tbody id="system-info"></tbody>
    </table>
</div>

<div id="process-section" class="hidden">
    <h3>Processes</h3>
    <table>
        <thead>
            <tr>
                <th></th>
                <th>PID</th>
                <th>Name</th>
                <th>CPU %</th>
                <th>Memory MB</th>
            </tr>
        </thead>
        <tbody id="processes"></tbody>
    </table>
</div>

<script>
let socket = null;
let selectedHost = null;
let reconnectAttempts = 0;
const maxReconnectAttempts = 5;

function connectWebSocket() {
    const statusEl = document.getElementById('connection-status');
    statusEl.textContent = 'Connecting...';
    statusEl.className = 'status connecting';

    socket = new WebSocket("ws://127.0.0.1:8000/ws/host-monitor/");

    socket.onopen = () => {
        console.log("WebSocket connected");
        statusEl.textContent = 'Connected';
        statusEl.className = 'status connected';
        reconnectAttempts = 0;
        
        // If we had a selected host, reselect it
        if (selectedHost) {
            sendHostSelection(selectedHost);
        }
    };

    socket.onclose = (event) => {
        console.log("WebSocket closed:", event.code, event.reason);
        statusEl.textContent = 'Disconnected';
        statusEl.className = 'status disconnected';
        
        // Attempt to reconnect
        if (reconnectAttempts < maxReconnectAttempts) {
            reconnectAttempts++;
            console.log(`Reconnecting... Attempt ${reconnectAttempts}/${maxReconnectAttempts}`);
            setTimeout(connectWebSocket, 3000 * reconnectAttempts); // Exponential backoff
        }
    };

    socket.onerror = (error) => {
        console.error("WebSocket error:", error);
        statusEl.textContent = 'Error';
        statusEl.className = 'status disconnected';
    };

    socket.onmessage = (event) => {
        const data = JSON.parse(event.data);
        
        if(data.error){
            alert(data.error);
            return;
        }

        // Update last update time
        const lastUpdateEl = document.getElementById('last-update');
        lastUpdateEl.textContent = `Last update: ${new Date().toLocaleTimeString()}`;

        // Update System Info dynamically
        if(data.system_info){
            updateSystemInfo(data.system_info);
        }

        // Update Processes dynamically
        if(data.processes){
            updateProcesses(data.processes);
        }
    };
}

function updateSystemInfo(si) {
    const systemInfoEl = document.getElementById('system-info');
    if (si.error) {
        systemInfoEl.innerHTML = `<tr><td colspan="2">Error: ${si.error}</td></tr>`;
    } else {
        systemInfoEl.innerHTML = `
            <tr><td>OS</td><td>${si.os_name || 'N/A'}</td></tr>
            <tr><td>Processor</td><td>${si.processor || 'N/A'}</td></tr>
            <tr><td>Cores/Threads</td><td>${si.num_cores || 'N/A'}/${si.num_threads || 'N/A'}</td></tr>
            <tr><td>RAM</td><td>${si.ram_used_gb || 'N/A'}/${si.ram_total_gb || 'N/A'} GB</td></tr>
            <tr><td>Storage</td><td>${si.storage_used_gb || 'N/A'}/${si.storage_total_gb || 'N/A'} GB</td></tr>
        `;
    }
}

function updateProcesses(processes) {
    const tbody = document.getElementById('processes');
    tbody.innerHTML = "";
    
    if (processes.length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="5">No processes available</td>`;
        tbody.appendChild(tr);
        return;
    }
    
    processes.forEach(proc => {
        const pid = proc.pid;
        const rowId = `proc-${pid}`;

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td class="expand-btn" onclick="toggleSubprocess('${rowId}')">&#9654;</td>
            <td>${pid}</td>
            <td>${proc.name || 'N/A'}</td>
            <td>${proc.cpu_percent || '0'}%</td>
            <td>${proc.memory_mb || '0'}</td>
        `;
        tbody.appendChild(tr);

        const subTr = document.createElement("tr");
        subTr.id = rowId;
        subTr.className = "subprocess-row";
        subTr.innerHTML = `<td colspan="5">No subprocesses available</td>`;
        tbody.appendChild(subTr);
    });
}

function sendHostSelection(hostname) {
    if (socket && socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({"hostname": hostname}));
        console.log("Sent hostname:", hostname);
    } else {
        console.log("WebSocket not ready, cannot send hostname");
    }
}

// Toggle visibility of sections
function toggleSection(sectionId){
    const section = document.getElementById(sectionId);
    if(section.classList.contains('hidden')){
        section.classList.remove('hidden');
    } else {
        section.classList.add('hidden');
    }
}

// Expand/Collapse subprocesses
function toggleSubprocess(rowId){
    const row = document.getElementById(rowId);
    row.style.display = row.style.display === "table-row" ? "none" : "table-row";
}

// Select a host and show control buttons
function selectHost(hostname){
    selectedHost = hostname;
    
    // Update UI to show selected host
    const buttons = document.querySelectorAll('#hosts-list button');
    buttons.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    document.getElementById('host-controls').classList.remove('hidden');
    
    // Send hostname to backend (only once - backend handles the updates)
    sendHostSelection(hostname);
}

// Initialize WebSocket connection when page loads
document.addEventListener('DOMContentLoaded', function() {
    connectWebSocket();
});
</script>

</body>
</html> 
